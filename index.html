<!DOCTYPE html>
<html>
  <head>
    <title>JS Formula</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="bootstrap-3.0.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="jsformulacalculator.js" type="text/javascript"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap-3.0.3/dist/js/bootstrap.min.js"></script>
    <script>
		$(document).ready(function(){
			$('#error-div').hide();
			$('#result-div').hide();
			$('#error-div2').hide();
			$('#result-div2').hide();
			$('#json-obj').val('{"a":[1,2,3,4]}');
			$('#formula').val('sum({a}) / len({a})');
			$('#json-obj2').val('{"x":5,"y":{"z":20, "t":{"q":3}}}');
			$('#formula2').val('pow({x},{y.t.q}) + {x} - {y.z} / {y.t.q}');
			var functions = {
				'pow' : function(x,y) {
					return Math.pow(x,y)
				},
				'max' : function(values) {
					if (!values) {
						return null;
					} else {
						var max = Number.MIN_VALUE
						values.forEach(function(x) {
							if (x > max) {
								max = x;
							}
						})
						return max;
					}
				},
				'len' : function(a) {
					return a.length
				},
				'sum' : function(a) {
					var total = 0;
					a.forEach(function(x){
						total += x
					});
					return total;
				}
			}
			_eval.setFunctions(functions);

			$('#calculate').click(function(){
				var formula = $('#formula').val(),
					obj,
					results,
					objString = $('#json-obj').val();

				try {
					if (objString) {
						obj = JSON.parse(objString);
					} else {
						obj = {}
					}
					var result = _eval(formula,obj)
					reportSuccess(result,'');
				} catch (err) {
					reportError(err.message,'');
				}
			});

			$('#compare').click(function(){
				var formula = $('#formula2').val(),
					obj,
					objString = $('#json-obj2').val(),
					cachedTime,
					uncachedTime,
					start,
					end,
					i;

				try {
					if (objString) {
						obj = JSON.parse(objString);
					} else {
						obj = {}
					}
					_eval.setCacheEnabled(false);
					start = new Date();
					for (i = 0; i < 10000; i++) {
						_eval(formula,obj);
					}
					end = new Date();
					uncachedTime = end - start;

					_eval.setCacheEnabled(true);
					start = new Date();
					for (i = 0; i < 10000; i++) {
						_eval(formula,obj);
					}
					end = new Date();
					cachedTime = end - start;

					reportSuccess('Uncached time: ' + uncachedTime + ' milliseconds, cached time: ' + cachedTime + ' milliseconds','2');
				} catch (err) {
					reportError(err.message,'2');
				}
			});
		});

		function reportError(message, pos) {
			$('#error-output' + pos).html(message);
			$('#result-div' + pos).hide();
			$('#error-div' + pos).show(150);
		}

		function reportSuccess(result, pos) {
			$('#result-output' + pos).html(result);
			$('#result-div' + pos).show(150);
			$('#error-div' + pos).hide();
		}

	</script>
  </head>
  <body style="padding-top:50px;">
  	<div class="container col-md-8 col-md-offset-2">
	  	<div class="jumbotron">
	  		<h1>
	  			JS Formula
	  		</h1>
	  		<p>
	  			JS Formula is Javascript utility that enables formula evaluation without the use of eval().
	  			Users can perform evaluation on JSON objects using the built in mathmatical opperators 
	  			<strong>+, - , / </strong> and <strong>*</strong> as well as <strong>define custom functions</strong> that the evaluator can use.
	  			<br/>
	  			<br/>
	  			<a href="#try">Try it out!</a>
	  		</p>
	  	</div>
	  	<h2>How to Use</h2>
	  	<p>
	  		JS Formula can evaluate formulas and return the result. If you want to use variables in your formulas make sure to wrap the variable in curly braces. To access nested attributes, place a dot in between the variable names. When you evaluate your formula, place the object with the variables as the second argument.
	  	</p>
	  	<p>
	  		To use your own functions in JS Formula create a key to function JSON object, and set it as the function set by calling the setFunctions method. After following these steps you can access your functions in the formula using the key you used in the JSON object.
	  	</p>
	  	<div>
	  		<h2>Example</h2>
	  		<pre>
		  		<code>
	var functions = {
		'sin' : function(x) {
			return Math.sin(x)
		},
		'pow' : function(x,y) {
			return Math.pow(x,y)
		}
	}
	_eval.setFunctions(functions)
	var formula = '{x} + 5';
	var obj = {x:20};
	var results = _eval(formula,obj);
	//results will be 25
		  		</code>
	  		</pre>
	  	</div>
	  	<div class="col-md-7" id="try">
	  		<h2>Try it!</h2>
		  	<form role="form">
		  		<div class="form-group">
		  			<label for="json-obj">JSON Object</label>
		  			<textarea id="json-obj" class="form-control"></textarea>
		  		</div>
		  		<div class="form-group">
		  			<label for="formula">Formula</label>
		  			<input type="text" class="form-control" id="formula"/>
		  		</div>
		  		<input class="btn btn-primary btn-block" type="button" id="calculate" value="calculate"/>
		  	</form>
		  	<div id="result-div" class="alert alert-success">
				<strong>Result</strong>
				<span id="result-output"></span>
			</div>
			<div id="error-div" class="alert alert-danger">
				<strong>Error</strong>
				<span id="error-output"></span>
			</div>
		</div>
		<div class="col-md-5 panel-group" id="test-methods">
			<h2>Functions Included for Demo</h2>
			<div class="panel">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
							sin(x)
						</a>
					</h4>
				</div>
				<div id="collapseOne" class="panel-collapse collapse">
					<div class="panel-body">
						<pre>
							<code>
function(x) {
	return Math.sin(x)
}
							</code>
						</pre>
					</div>
				</div>
			</div>
			<div class="panel">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
							pow(x,y)
						</a>
					</h4>
				</div>
				<div id="collapseTwo" class="panel-collapse collapse">
					<div class="panel-body">
						<pre>
							<code>
function(x,y) {
	return Math.pow(x,y)
}
							</code>
						</pre>
					</div>
				</div>
			</div>
			<div class="panel">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
							max(a)
						</a>
					</h4>
				</div>
				<div id="collapseThree" class="panel-collapse collapse">
					<div class="panel-body">
						<pre>
							<code>
function(values) {
	if (!values) {
		return null;
	} else {
		var max = Number.MIN_VALUE
		values.forEach(function(x) {
			if (x > max) {
				max = x;
			}
		})
		return max;
	}
}
							</code>
						</pre>
					</div>
				</div>
			</div>
			<div class="panel">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
							len(a)
						</a>
					</h4>
				</div>
				<div id="collapseFour" class="panel-collapse collapse">
					<div class="panel-body">
						<pre>
							<code>
function(a) {
	return a.length
}
							</code>
						</pre>
					</div>
				</div>
			</div>
			<div class="panel">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
							sum(a)
						</a>
					</h4>
				</div>
				<div id="collapseFive" class="panel-collapse collapse">
					<div class="panel-body">
						<pre>
							<code>
function(a) {
	var total = 0;
	a.forEach(function(x){
		total += x
	});
	return total;
}
							</code>
						</pre>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-12">
			<h2>Why is JS Formula special?</h2>
			<p>
			What sets JS Formula appart from other JavaScript formula evaluators is how it evaluates the formula. JS Formula does not just simply evaluate formula's, but instead <strong>builds a Formula object</strong> that can be traversed and evaluated. By taking this approach, the <strong>Formula object can be cached</strong>, which provides <strong>significant performance increase</strong> the next time the same formula string is asked to be evaluated, even with different objects.
			</p>
		</div>
		<div class="col-md-12">
	  		<h2>Compare Your Self!</h2>
	  		<p>
	  		The function you enter here will be evaluate 10,000 times by both the uncached version and the cached version. It will then output how long it took to evaluate the 10,000 formulas for each version. <strong>The functions in the previous demo are still available.</strong>
	  		</p>
		  	<form role="form">
		  		<div class="form-group">
		  			<label for="json-obj2">JSON Object</label>
		  			<textarea id="json-obj2" class="form-control"></textarea>
		  		</div>
		  		<div class="form-group">
		  			<label for="formula2">Formula</label>
		  			<input type="text" class="form-control" id="formula2"/>
		  		</div>
		  		<input class="btn btn-primary btn-block" type="button" id="compare" value="calculate"/>
		  	</form>
		  	<div id="result-div2" class="alert alert-success">
				<strong>Result</strong>
				<span id="result-output2"></span>
			</div>
			<div id="error-div2" class="alert alert-danger">
				<strong>Error</strong>
				<span id="error-output2"></span>
			</div>
		</div>
		<div class="col-md-12">
			<h2>Build Dynamic Reusable Functions</h2>
			<p>
			JS Formula is able to build functions based on formulas. The function can then be called with a an object parameter and will return the output of the formula used to define the function.
			</p>
		</div>
		<div class="col-md-12">
	  		<h2>Example</h2>
	  		<pre>
		  		<code>
	var add4 = _eval.getFunction('4 + {x}');
	var result = add4({x: 10});
	//result will be 14
		  		</code>
	  		</pre>
	  	</div>
	</div>
	<div>
	</div>
  </body>
</html>